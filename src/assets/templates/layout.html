<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title }}</title>
    <link rel="stylesheet" href="/base.css" />
    <!-- Syntax highlighting theme -->
    <link
      id="hljs-theme"
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@latest/build/styles/github.min.css"
    />
    <!-- Markdown renderer + sanitizer + highlighter -->
    <script src="https://cdn.jsdelivr.net/npm/marked@latest/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@latest/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@latest/build/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@latest/build/languages/typescript.min.js"></script>
    <script>
      (function () {
        function setHljsTheme(theme) {
          try {
            var el = document.getElementById("hljs-theme");
            if (!el) return;
            var base = "https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@latest/build/styles/";
            var href =
              theme === "dark" ? base + "github-dark-dimmed.min.css" : base + "github.min.css";
            if (el.getAttribute("href") !== href) el.setAttribute("href", href);
          } catch {}
        }
        try {
          var t = localStorage.getItem("theme");
          if (!t) {
            if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches)
              t = "dark";
            else t = "light";
          }
          document.documentElement.setAttribute("data-theme", t);
          setHljsTheme(t);
          window.__toggleTheme = function () {
            var cur = document.documentElement.getAttribute("data-theme") || "light";
            var next = cur === "dark" ? "light" : "dark";
            document.documentElement.setAttribute("data-theme", next);
            setHljsTheme(next);
            try {
              localStorage.setItem("theme", next);
            } catch {}
          };
        } catch {}
      })();
    </script>
    <script>
      // Render any markdown blocks present on the page and rewrite relative links/images
      // based on the container's data attributes: data-md-owner, data-md-repo, data-md-ref, data-md-base
      (function () {
        function isAbsoluteUrl(href) {
          return /^(?:[a-z]+:)?\/\//i.test(href) || href.startsWith("/") || href.startsWith("#");
        }
        function joinPath(base, rel) {
          if (!base) base = "";
          if (!rel) return base;
          // Strip query/fragment for path resolution, preserve to append later
          var frag = "";
          var q = rel.indexOf("#");
          if (q !== -1) {
            frag = rel.slice(q);
            rel = rel.slice(0, q);
          }
          var baseParts = base.split("/").filter(Boolean);
          var relParts = rel.split("/").filter(function (p) {
            return p.length > 0;
          });
          relParts.forEach(function (p) {
            if (p === ".") return;
            if (p === "..") baseParts.pop();
            else baseParts.push(p);
          });
          var out = baseParts.join("/");
          return out + frag;
        }
        function rewriteRelativeLinks(container) {
          try {
            var owner = container.getAttribute("data-md-owner") || "";
            var repo = container.getAttribute("data-md-repo") || "";
            var ref = container.getAttribute("data-md-ref") || "";
            var base = container.getAttribute("data-md-base") || "";
            if (!owner || !repo || !ref) return; // nothing to do
            // Normalize base to a directory path (no trailing slash)
            if (base.endsWith("/")) base = base.slice(0, -1);

            // Rewrite anchors
            container.querySelectorAll("a[href]").forEach(function (a) {
              var href = a.getAttribute("href") || "";
              if (!href || isAbsoluteUrl(href)) return;
              // Preserve fragment if present
              var frag = "";
              var i = href.indexOf("#");
              if (i !== -1) {
                frag = href.slice(i);
                href = href.slice(0, i);
              }
              var resolved = joinPath(base, href);
              var url =
                "/" +
                encodeURIComponent(owner) +
                "/" +
                encodeURIComponent(repo) +
                "/blob?ref=" +
                encodeURIComponent(ref) +
                "&path=" +
                encodeURIComponent(resolved) +
                frag;
              a.setAttribute("href", url);
            });

            // Rewrite images to raw-by-path endpoint so they render inline
            container.querySelectorAll("img[src]").forEach(function (img) {
              var src = img.getAttribute("src") || "";
              if (!src || isAbsoluteUrl(src)) return;
              var resolved = joinPath(base, src);
              var name = resolved.split("/").pop() || "file";
              var url =
                "/" +
                encodeURIComponent(owner) +
                "/" +
                encodeURIComponent(repo) +
                "/rawpath?ref=" +
                encodeURIComponent(ref) +
                "&path=" +
                encodeURIComponent(resolved) +
                "&name=" +
                encodeURIComponent(name);
              img.setAttribute("src", url);
            });
          } catch {}
        }
        function renderMarkdownBlocks() {
          try {
            var nodes = document.querySelectorAll('[data-markdown="1"]');
            nodes.forEach(function (node) {
              var pre = node.querySelector("pre.md-src");
              if (!pre) return;
              var raw = pre.textContent || "";
              var html = marked.parse(raw);
              var clean = DOMPurify.sanitize(html, { USE_PROFILES: { html: true } });
              node.innerHTML = clean;
              rewriteRelativeLinks(node);
              node.querySelectorAll("pre code").forEach(function (el) {
                try {
                  hljs.highlightElement(el);
                } catch {}
              });
            });
          } catch {}
        }
        function run() {
          renderMarkdownBlocks();
          try {
            hljs.highlightAll();
          } catch {}
        }
        if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", run);
        else run();
      })();
    </script>
  </head>
  <body>
    <header
      style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      "
    >
      <div>
        <a href="/" style="font-weight: 700">git-on-cloudflare</a>
        <a href="/auth" style="margin-left: 12px">Auth</a>
      </div>
      <div>
        <button class="btn secondary" onclick="__toggleTheme()">Toggle theme</button>
      </div>
    </header>
    {{ body }}
  </body>
</html>
