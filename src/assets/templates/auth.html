<div class="container">
  <div class="header">
    <h1>Auth Management</h1>
    <div class="right">Centralized (owner → token) store</div>
  </div>
  <p class="muted">
    Use your root admin token to manage owners and tokens. Tokens are stored as SHA‑256 hashes. You
    can add and delete owners; individual token removal coming later.
  </p>

  <div id="message" class="message" style="display: none" aria-live="polite" role="status"></div>

  <div class="cards">
    <div class="card">
      <h3>1) Admin Token</h3>
      <div class="row">
        <input id="adm" type="password" placeholder="Enter AUTH_ADMIN_TOKEN" />
        <button class="btn" id="load">Load Users</button>
      </div>
      <div class="help muted">
        Your browser will remember this for the current tab (localStorage).
      </div>
    </div>
    <div class="card">
      <h3>2) Add Owner / Token</h3>
      <div class="row">
        <input id="owner" placeholder="owner (e.g., rachel)" />
        <input id="token" placeholder="token (raw)" />
        <button class="btn" id="add">Add</button>
      </div>
      <div class="help muted">
        Tip: Each collaborator uses their own token. For Git Basic auth, set username = owner and
        password = token.
      </div>
    </div>
  </div>

  <div class="card users">
    <div style="display: flex; justify-content: space-between; align-items: center">
      <h3>Owners</h3>
      <span class="badge" id="owners-count">0 owners</span>
    </div>
    <div id="users" class="empty">(none)</div>
  </div>

  <div class="tips">
    <h3>Usage examples</h3>
    <ul class="muted">
      <li>Git Basic auth: use <code>username = owner</code>, <code>password = token</code>.</li>
      <li>
        Bearer:
        <code
          >git -c http.extraHeader="Authorization: Bearer TOKEN" push http://host/owner/repo
          main</code
        >
      </li>
    </ul>
  </div>
</div>
<script>
  const el = (id) => document.getElementById(id);
  function showMessage(text, isError = false) {
    const msg = el("message");
    msg.textContent = text;
    msg.className = isError ? "message error" : "message success";
    msg.style.display = "block";
    setTimeout(() => {
      msg.style.display = "none";
    }, 4000);
  }

  async function api(path, opts = {}) {
    const adm = el("adm").value.trim();
    const headers = Object.assign({ Authorization: "Bearer " + adm }, opts.headers || {});
    const res = await fetch("/auth/api" + path, Object.assign({}, opts, { headers }));
    if (!res.ok) {
      showMessage(
        "Error " + res.status + ": " + (await res.text().catch(() => "Request failed")),
        true
      );
      return null;
    }
    return await res.json();
  }
  async function load() {
    const data = await api("/users");
    if (!data) return;
    const div = el("users");
    const count = (data.users && data.users.length) || 0;
    el("owners-count").textContent = count + (count === 1 ? " owner" : " owners");
    if (!data.users || !data.users.length) {
      div.className = "empty";
      div.innerHTML = "(none)";
      showMessage("No owners found");
      return;
    }
    div.className = "";
    div.innerHTML = data.users
      .map(function (u) {
        const tokensHtml = (u.tokens || [])
          .map(function (h) {
            return (
              '<span class="token"><code>' +
              String(h).slice(0, 8) +
              '…</code><button class="x del-token" title="Delete token" data-owner="' +
              u.owner +
              '" data-hash="' +
              h +
              '">×</button></span>'
            );
          })
          .join(" ");
        return (
          '<div class="owner">\
      <div>\
        <b>' +
          u.owner +
          '</b>\
        <div class="muted">tokens: ' +
          (u.tokens ? u.tokens.length : 0) +
          "</div>\
        <div>" +
          (tokensHtml || '<span class="muted">(no tokens)</span>') +
          '</div>\
      </div>\
      <div>\
        <button class="btn secondary del-owner" data-owner="' +
          u.owner +
          '">Delete Owner</button>\
      </div>\
    </div>'
        );
      })
      .join("");
    Array.from(div.querySelectorAll(".del-owner")).forEach((btn) => {
      btn.onclick = async () => {
        const owner = btn.getAttribute("data-owner");
        if (!confirm("Delete " + owner + "?")) return;
        const result = await api("/users", {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ owner }),
        });
        if (result) {
          showMessage("Owner '" + owner + "' deleted successfully");
          await load();
        }
      };
    });
    Array.from(div.querySelectorAll(".del-token")).forEach((btn) => {
      btn.onclick = async () => {
        const owner = btn.getAttribute("data-owner");
        const tokenHash = btn.getAttribute("data-hash");
        if (!owner || !tokenHash) return;
        if (!confirm("Delete token " + tokenHash.slice(0, 8) + "… for " + owner + "?")) return;
        const result = await api("/users", {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ owner, tokenHash }),
        });
        if (result) {
          showMessage("Token deleted successfully for '" + owner + "'");
          await load();
        }
      };
    });
  }
  el("load").onclick = load;
  el("add").onclick = async () => {
    const owner = el("owner").value.trim();
    const token = el("token").value.trim();
    if (!owner || !token) {
      showMessage("Owner and token required", true);
      return;
    }
    const result = await api("/users", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ owner, token }),
    });
    if (result) {
      showMessage("Owner '" + owner + "' and token added successfully");
      el("token").value = "";
      await load();
    }
  };
  try {
    const saved = localStorage.getItem("adminToken");
    if (saved) el("adm").value = saved;
    el("adm").addEventListener("input", () => localStorage.setItem("adminToken", el("adm").value));
  } catch {}
</script>
