{% layout 'layout' %}
{% block %}
{% render 'repo_nav', owner: owner, repo: repo, refEnc: refEnc, currentTab: 'browse' %}
<h2>Blob: {{ fileName }}</h2>
<div class="blob-container mt-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/30">
  <div class="flex items-center justify-between px-3 py-2 border-b border-gray-200 dark:border-gray-700">
    <div class="flex items-center gap-2 text-xs text-gray-600 dark:text-gray-400">
      {% if codeLang %}
        <span class="inline-flex items-center rounded border border-gray-300 dark:border-gray-600 px-2 py-0.5 bg-gray-50 dark:bg-gray-800/50">
          {{- codeLang -}}
        </span>
      {% endif %}
      {% if isMarkdown %}
        <span class="inline-flex items-center rounded border border-gray-300 dark:border-gray-600 px-2 py-0.5 bg-gray-50 dark:bg-gray-800/50">
          Markdown
        </span>
      {% endif %}
      {% if isMarkdown or codeLang %}
        {% if lineCount %}
          <span class="text-gray-500 dark:text-gray-400">
            {{- lineCount }} line{% if lineCount != 1 %}s{% endif -%}
          </span>
        {% endif %}
      {% elsif sizeStr %}
        <span class="text-gray-500 dark:text-gray-400">{{ sizeStr }}</span>
      {% endif %}
    </div>
    <div class="flex items-center gap-2">
      <div class="hidden sm:flex items-center gap-2">
        <div class="segmented">
          {% if not isMarkdown and not isImage and not isPdf and not isBinary and not tooLarge %}
            <button class="copy-raw seg action" type="button">Copy</button>
          {% endif %}
          {% unless isImage or isPdf %}
            <a id="view-raw-link" class="seg action" href="{{ viewRawHref }}">View</a>
          {% endunless %}
          <span class="seg label">Raw</span>
        </div>
        <a class="btn sm" href="{{ rawHref }}">Download</a>
      </div>
      <div class="sm:hidden">
        <details class="ref-menu relative">
          <summary class="btn secondary sm inline-flex items-center gap-2">
            <i class="bi bi-three-dots w-4 h-4" aria-hidden="true"></i>
          </summary>
          <div class="fixed inset-x-0 z-20 mt-2 mx-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-2 shadow-xl">
            <div class="flex flex-col">
              {% if not isMarkdown and not isImage and not isPdf and not isBinary and not tooLarge %}
                <button
                  type="button"
                  class="copy-raw flex items-center gap-2 px-3 py-2 rounded text-left hover:bg-gray-100 dark:hover:bg-gray-700"
                >
                  <i class="bi bi-clipboard w-4 h-4" aria-hidden="true"></i>
                  <span>Copy raw</span>
                </button>
              {% endif %}
              {% unless isImage or isPdf %}
                <a
                  href="{{ viewRawHref }}"
                  class="flex items-center gap-2 px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700"
                >
                  <i class="bi bi-file-earmark-text w-4 h-4" aria-hidden="true"></i>
                  <span>View raw</span>
                </a>
              {% endunless %}
              <a
                href="{{ rawHref }}"
                class="flex items-center gap-2 px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700"
              >
                <i class="bi bi-download w-4 h-4" aria-hidden="true"></i>
                <span>Download</span>
              </a>
            </div>
          </div>
        </details>
      </div>
    </div>
  </div>
  <div class="{%- if contentClass %}{{ contentClass }}{% endif %} {% if isMarkdown %}p-5{% elsif isBinary or tooLarge %}p-3{% else %}p-1{% endif %}">
    {% if tooLarge %}
      <div class="muted">File too large to preview.</div>
    {% elsif isImage and mediaSrc %}
      <div class="flex items-center justify-center">
        <img src="{{ mediaSrc }}" alt="{{ fileName }}" class="max-w-full rounded-md" loading="lazy">
      </div>
    {% elsif isPdf and mediaSrc %}
      <div class="w-full" style="height: 75vh;">
        <iframe
          src="{{ mediaSrc }}"
          class="w-full h-full rounded-md"
          title="{{ fileName }}"
          loading="lazy"
        ></iframe>
      </div>
    {% elsif isMarkdown %}
      <div
        data-markdown="1"
        data-md-owner="{{ mdOwner }}"
        data-md-repo="{{ mdRepo }}"
        data-md-ref="{{ mdRef }}"
        data-md-base="{{ mdBase }}"
      >
        <pre class="md-src">{{ markdownRaw }}</pre>
      </div>
    {% elsif isBinary %}
      <div class="muted">Binary file.</div>
    {% else %}
      {% if codeLang %}
        <pre id="blob-pre"><code id="blob-code" class="language-{{ codeLang }}">{{ codeText }}</code></pre>
      {% else %}
        <pre id="blob-pre"><code id="blob-code" class="language-plaintext">{{ codeText }}</code></pre>
      {% endif %}
    {% endif %}
  </div>
</div>
<script>
  (function () {
    function handleCopyClick(event) {
      var btn = event.currentTarget;
      var link = document.getElementById('view-raw-link');
      var href = (link && link.getAttribute('href')) || '{{ viewRawHref }}';
      fetch(href, { credentials: 'same-origin' })
        .then(function (res) {
          return res.text();
        })
        .then(function (txt) {
          return navigator.clipboard.writeText(txt);
        })
        .then(function () {
          var old = btn.textContent;
          btn.textContent = 'Copied';
          setTimeout(function () {
            btn.textContent = old;
            var dd = btn.closest && btn.closest('details');
            if (dd) dd.removeAttribute('open');
          }, 1200);
        })
        .catch(function (err) {
          console.warn('Copy failed', err);
        });
    }

    var copyButtons = document.querySelectorAll('.copy-raw');
    for (var i = 0; i < copyButtons.length; i++) {
      copyButtons[i].addEventListener('click', handleCopyClick);
    }
  })();
</script>
{% endblock %}
